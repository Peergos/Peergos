"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var InMemory_1 = require('./InMemory');
var api_error_1 = require('../core/api_error');
var fs = require('../core/node_fs');
var path = require('path');
var util_1 = require('../core/util');
var MountableFileSystem = (function (_super) {
    __extends(MountableFileSystem, _super);
    function MountableFileSystem() {
        _super.call(this);
        this.mountList = [];
        this.mntMap = {};
        this.rootFs = new InMemory_1["default"]();
    }
    MountableFileSystem.prototype.mount = function (mountPoint, fs) {
        if (mountPoint[0] !== '/') {
            mountPoint = "/" + mountPoint;
        }
        mountPoint = path.resolve(mountPoint);
        if (this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already taken.");
        }
        util_1.mkdirpSync(mountPoint, 0x1ff, this.rootFs);
        this.mntMap[mountPoint] = fs;
        this.mountList.push(mountPoint);
        this.mountList = this.mountList.sort(function (a, b) { return b.length - a.length; });
    };
    MountableFileSystem.prototype.umount = function (mountPoint) {
        if (mountPoint[0] !== '/') {
            mountPoint = "/" + mountPoint;
        }
        mountPoint = path.resolve(mountPoint);
        if (!this.mntMap[mountPoint]) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Mount point " + mountPoint + " is already unmounted.");
        }
        delete this.mntMap[mountPoint];
        this.mountList.splice(this.mountList.indexOf(mountPoint), 1);
        while (mountPoint !== '/') {
            if (this.rootFs.readdirSync(mountPoint).length === 0) {
                this.rootFs.rmdirSync(mountPoint);
                mountPoint = path.dirname(mountPoint);
            }
            else {
                break;
            }
        }
    };
    MountableFileSystem.prototype._getFs = function (path) {
        var mountList = this.mountList, len = mountList.length;
        for (var i_1 = 0; i_1 < len; i_1++) {
            var mountPoint = mountList[i_1];
            if (mountPoint.length <= path.length && path.indexOf(mountPoint) === 0) {
                path = path.substr(mountPoint.length > 1 ? mountPoint.length : 0);
                if (path === '') {
                    path = '/';
                }
                return { fs: this.mntMap[mountPoint], path: path };
            }
        }
        return { fs: this.rootFs, path: path };
    };
    MountableFileSystem.prototype.getName = function () {
        return 'MountableFileSystem';
    };
    MountableFileSystem.isAvailable = function () {
        return true;
    };
    MountableFileSystem.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    MountableFileSystem.prototype.isReadOnly = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsLinks = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsProps = function () {
        return false;
    };
    MountableFileSystem.prototype.supportsSynch = function () {
        return true;
    };
    MountableFileSystem.prototype.standardizeError = function (err, path, realPath) {
        var index;
        if (-1 !== (index = err.message.indexOf(path))) {
            err.message = err.message.substr(0, index) + realPath + err.message.substr(index + path.length);
            err.path = realPath;
        }
        return err;
    };
    MountableFileSystem.prototype.rename = function (oldPath, newPath, cb) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            var _this = this;
            return fs1_rv.fs.rename(fs1_rv.path, fs2_rv.path, function (e) {
                if (e)
                    _this.standardizeError(_this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                cb(e);
            });
        }
        return fs.readFile(oldPath, function (err, data) {
            if (err) {
                return cb(err);
            }
            fs.writeFile(newPath, data, function (err) {
                if (err) {
                    return cb(err);
                }
                fs.unlink(oldPath, cb);
            });
        });
    };
    MountableFileSystem.prototype.renameSync = function (oldPath, newPath) {
        var fs1_rv = this._getFs(oldPath);
        var fs2_rv = this._getFs(newPath);
        if (fs1_rv.fs === fs2_rv.fs) {
            try {
                return fs1_rv.fs.renameSync(fs1_rv.path, fs2_rv.path);
            }
            catch (e) {
                this.standardizeError(this.standardizeError(e, fs1_rv.path, oldPath), fs2_rv.path, newPath);
                throw e;
            }
        }
        var data = fs.readFileSync(oldPath);
        fs.writeFileSync(newPath, data);
        return fs.unlinkSync(oldPath);
    };
    MountableFileSystem.prototype.readdirSync = function (p) {
        var fsInfo = this._getFs(p);
        var rv = null;
        if (fsInfo.fs !== this.rootFs) {
            try {
                rv = this.rootFs.readdirSync(p);
            }
            catch (e) {
            }
        }
        try {
            var rv2_1 = fsInfo.fs.readdirSync(fsInfo.path);
            if (rv === null) {
                return rv2_1;
            }
            else {
                return rv2_1.concat(rv.filter(function (val) { return rv2_1.indexOf(val) === -1; }));
            }
        }
        catch (e) {
            if (rv === null) {
                throw this.standardizeError(e, fsInfo.path, p);
            }
            else {
                return rv;
            }
        }
    };
    MountableFileSystem.prototype.readdir = function (p, cb) {
        var _this = this;
        var fsInfo = this._getFs(p);
        fsInfo.fs.readdir(fsInfo.path, function (err, files) {
            if (fsInfo.fs !== _this.rootFs) {
                try {
                    var rv = _this.rootFs.readdirSync(p);
                    if (files) {
                        files = files.concat(rv.filter(function (val) { return files.indexOf(val) === -1; }));
                    }
                    else {
                        files = rv;
                    }
                }
                catch (e) {
                    if (err) {
                        return cb(_this.standardizeError(err, fsInfo.path, p));
                    }
                }
            }
            else if (err) {
                return cb(_this.standardizeError(err, fsInfo.path, p));
            }
            cb(null, files);
        });
    };
    MountableFileSystem.prototype.rmdirSync = function (p) {
        var fsInfo = this._getFs(p);
        if (this._containsMountPt(p)) {
            throw api_error_1.ApiError.ENOTEMPTY(p);
        }
        else {
            try {
                fsInfo.fs.rmdirSync(fsInfo.path);
            }
            catch (e) {
                throw this.standardizeError(e, fsInfo.path, p);
            }
        }
    };
    MountableFileSystem.prototype._containsMountPt = function (p) {
        var mountPoints = this.mountList, len = mountPoints.length;
        for (var i_2 = 0; i_2 < len; i_2++) {
            var pt = mountPoints[i_2];
            if (pt.length >= p.length && pt.slice(0, p.length) === p) {
                return true;
            }
        }
        return false;
    };
    MountableFileSystem.prototype.rmdir = function (p, cb) {
        var _this = this;
        var fsInfo = this._getFs(p);
        if (this._containsMountPt(p)) {
            cb(api_error_1.ApiError.ENOTEMPTY(p));
        }
        else {
            fsInfo.fs.rmdir(fsInfo.path, function (err) {
                cb(err ? _this.standardizeError(err, fsInfo.path, p) : null);
            });
        }
    };
    return MountableFileSystem;
}(file_system.BaseFileSystem));
exports.__esModule = true;
exports["default"] = MountableFileSystem;
function defineFcn(name, isSync, numArgs) {
    if (isSync) {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            try {
                return rv.fs[name].apply(rv.fs, args);
            }
            catch (e) {
                self.standardizeError(e, rv.path, path);
                throw e;
            }
        };
    }
    else {
        return function () {
            var args = [];
            for (var _i = 0; _i < arguments.length; _i++) {
                args[_i - 0] = arguments[_i];
            }
            var self = this;
            var path = args[0];
            var rv = self._getFs(path);
            args[0] = rv.path;
            if (typeof args[args.length - 1] === 'function') {
                var cb = args[args.length - 1];
                args[args.length - 1] = function () {
                    var args = [];
                    for (var _i = 0; _i < arguments.length; _i++) {
                        args[_i - 0] = arguments[_i];
                    }
                    if (args.length > 0 && args[0] instanceof api_error_1.ApiError) {
                        self.standardizeError(args[0], rv.path, path);
                    }
                    cb.apply(null, args);
                };
            }
            return rv.fs[name].apply(rv.fs, args);
        };
    }
}
var fsCmdMap = [
    ['exists', 'unlink', 'readlink'],
    ['stat', 'mkdir', 'realpath', 'truncate'],
    ['open', 'readFile', 'chmod', 'utimes'],
    ['chown'],
    ['writeFile', 'appendFile']];
for (var i = 0; i < fsCmdMap.length; i++) {
    var cmds = fsCmdMap[i];
    for (var j = 0; j < cmds.length; j++) {
        var fnName = cmds[j];
        MountableFileSystem.prototype[fnName] = defineFcn(fnName, false, i + 1);
        MountableFileSystem.prototype[fnName + 'Sync'] = defineFcn(fnName + 'Sync', true, i + 1);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTW91bnRhYmxlRmlsZVN5c3RlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYWNrZW5kL01vdW50YWJsZUZpbGVTeXN0ZW0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsSUFBTyxXQUFXLFdBQVcscUJBQXFCLENBQUMsQ0FBQztBQUNwRCx5QkFBK0IsWUFBWSxDQUFDLENBQUE7QUFDNUMsMEJBQWtDLG1CQUFtQixDQUFDLENBQUE7QUFDdEQsSUFBTyxFQUFFLFdBQVcsaUJBQWlCLENBQUMsQ0FBQztBQUN2QyxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUM5QixxQkFBeUIsY0FBYyxDQUFDLENBQUE7QUFXeEM7SUFBaUQsdUNBQTBCO0lBT3pFO1FBQ0UsaUJBQU8sQ0FBQztRQUhGLGNBQVMsR0FBYSxFQUFFLENBQUM7UUFJL0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFHakIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHFCQUFrQixFQUFFLENBQUM7SUFDekMsQ0FBQztJQUtNLG1DQUFLLEdBQVosVUFBYSxVQUFrQixFQUFFLEVBQTBCO1FBQ3pELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFCLFVBQVUsR0FBRyxNQUFJLFVBQVksQ0FBQztRQUNoQyxDQUFDO1FBQ0QsVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsTUFBTSxJQUFJLG9CQUFRLENBQUMscUJBQVMsQ0FBQyxNQUFNLEVBQUUsY0FBYyxHQUFHLFVBQVUsR0FBRyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzNGLENBQUM7UUFDRCxpQkFBVSxDQUFDLFVBQVUsRUFBRSxLQUFLLEVBQUUs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QUMsQ0FBQztRQUNkLG1CQUFtQixDQUFDLFNBQVUsQ0FBQyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDekUsbUJBQW1CLENBQUMsU0FBVSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxHQUFHLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ25HLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZpbGVfc3lzdGVtID0gcmVxdWlyZSgnLi4vY29yZS9maWxlX3N5c3RlbScpO1xyXG5pbXBvcnQgSW5NZW1vcnlGaWxlU3lzdGVtIGZyb20gJy4vSW5NZW1vcnknO1xyXG5pbXBvcnQge0FwaUVycm9yLCBFcnJvckNvZGV9IGZyb20gJy4uL2NvcmUvYXBpX2Vycm9yJztcclxuaW1wb3J0IGZzID0gcmVxdWlyZSgnLi4vY29yZS9ub2RlX2ZzJyk7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5pbXBvcnQge21rZGlycFN5bmN9IGZyb20gJy4uL2NvcmUvdXRpbCc7XHJcblxyXG4vKipcclxuICogVGhlIE1vdW50YWJsZUZpbGVTeXN0ZW0gYWxsb3dzIHlvdSB0byBtb3VudCBtdWx0aXBsZSBiYWNrZW5kIHR5cGVzIG9yXHJcbiAqIG11bHRpcGxlIGluc3RhbnRpYXRpb25zIG9mIHRoZSBzYW1lIGJhY2tlbmQgaW50byBhIHNpbmdsZSBmaWxlIHN5c3RlbSB0cmVlLlxyXG4gKiBUaGUgZmlsZSBzeXN0ZW1zIGRvIG5vdCBuZWVkIHRvIGtub3cgYWJvdXQgZWFjaCBvdGhlcjsgYWxsIGludGVyYWN0aW9ucyBhcmVcclxuICogYXV0b21hdGljYWxseSBmYWNpbGl0YXRlZCB0aHJvdWdoIHRoaXMgaW50ZXJmYWNlLlxyXG4gKlxyXG4gKiBGb3IgZXhhbXBsZSwgaWYgYSBmaWxlIHN5c3RlbSBpcyBtb3VudGVkIGF0IC9tbnQvYmxhaCwgYW5kIGEgcmVxdWVzdCBjYW1lIGluXHJcbiAqIGZvciAvbW50L2JsYWgvZm9vLnR4dCwgdGhlIGZpbGUgc3lzdGVtIHdvdWxkIHNlZSBhIHJlcXVlc3QgZm9yIC9mb28udHh0LlxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW91bnRhYmxlRmlsZVN5c3RlbSBleHRlbmRzIGZpbGVfc3lzdGVtLkJhc2VGaWxlU3lzdGVtIGltcGxlbWVudHMgZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbSB7XHJcbiAgcHJpdmF0ZSBtbnRNYXA6IHtbcGF0aDogc3RyaW5nXTogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbX07XHJcbiAgLy8gQ29udGFpbnMgdGhlIGxpc3Qgb2YgbW91bnQgcG9pbnRzIGluIG1udE1hcCwgc29ydGVkIGJ5IHN0cmluZyBsZW5ndGggaW4gZGVjcmVhc2luZyBvcmRlci5cclxuICAvLyBFbnN1cmVzIHRoYXQgd2Ugc2NhbiB0aGUgbW9zdCBzcGVjaWZpYyBtb3VudCBwb2ludHMgZm9yIGEgbWF0Y2ggZmlyc3QsIHdoaWNoIGxldHMgdXNcclxuICAvLyBuZXN0IG1vdW50IHBvaW50cy5cclxuICBwcml2YXRlIG1vdW50TGlzdDogc3RyaW5nW10gPSBbXTtcclxuICBwcml2YXRlIHJvb3RGczogZmlsZV9zeXN0ZW0uRmlsZVN5c3RlbTtcclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLm1udE1hcCA9IHt9O1xyXG4gICAgLy8gVGhlIEluTWVtb3J5IGZpbGUgc3lzdGVtIHNlcnZlcyBwdXJlbHkgdG8gcHJvdmlkZSBkaXJlY3RvcnkgbGlzdGluZ3MgZm9yXHJcbiAgICAvLyBtb3VudGVkIGZpbGUgc3lzdGVtcy5cclxuICAgIHRoaXMucm9vdEZzID0gbmV3IEluTWVtb3J5RmlsZVN5c3RlbSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTW91bnRzIHRoZSBmaWxlIHN5c3RlbSBhdCB0aGUgZ2l2ZW4gbW91bnQgcG9pbnQuXHJcbiAgICovXHJcbiAgcHVibGljIG1vdW50KG1vdW50UG9pbnQ6IHN0cmluZywgZnM6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0pOiB2b2lkIHtcclxuICAgIGlmIChtb3VudFBvaW50WzBdICE9PSAnLycpIHtcclxuICAgICAgbW91bnRQb2ludCA9IGAvJHttb3VudFBvaW50fWA7XHJcbiAgICB9XHJcbiAgICBtb3VudFBvaW50ID0gcGF0aC5yZXNvbHZlKG1vdW50UG9pbnQpO1xyXG4gICAgaWYgKHRoaXMubW50TWFwW21vdW50UG9pbnRdKSB7XHJcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIk1vdW50IHBvaW50IFwiICsgbW91bnRQb2ludCArIFwiIGlzIGFscmVhZHkgdGFrZW4uXCIpO1xyXG4gICAgfVxyXG4gICAgbWtkaXJwU3luYyhtb3VudFBvaW50LCAweDFmZiwgdGhpcy5yb290RnMpO1xyXG4gICAgdGhpcy5tbnRNYXBbbW91bnRQb2ludF0gPSBmcztcclxuICAgIHRoaXMubW91bnRMaXN0LnB1c2gobW91bnRQb2ludCk7XHJcbiAgICB0aGlzLm1vdW50TGlzdCA9IHRoaXMubW91bnRMaXN0LnNvcnQoKGEsIGIpID0+IGIubGVuZ3RoIC0gYS5sZW5ndGgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHVtb3VudChtb3VudFBvaW50OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmIChtb3VudFBvaW50WzBdICE9PSAnLycpIHtcclxuICAgICAgbW91bnRQb2ludCA9IGAvJHttb3VudFBvaW50fWA7XHJcbiAgICB9XHJcbiAgICBtb3VudFBvaW50ID0gcGF0aC5yZXNvbHZlKG1vdW50UG9pbnQpO1xyXG4gICAgaWYgKCF0aGlzLm1udE1hcFttb3VudFBvaW50XSkge1xyXG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgXCJNb3VudCBwb2ludCBcIiArIG1vdW50UG9pbnQgKyBcIiBpcyBhbHJlYWR5IHVubW91bnRlZC5cIik7XHJcbiAgICB9XHJcbiAgICBkZWxldGUgdGhpcy5tbnRNYXBbbW91bnRQb2ludF07XHJcbiAgICB0aGlzLm1vdW50TGlzdC5zcGxpY2UodGhpcy5tb3VudExpc3QuaW5kZXhPZihtb3VudFBvaW50KSwgMSk7XHJcblxyXG4gICAgd2hpbGUgKG1vdW50UG9pbnQgIT09ICcvJykge1xyXG4gICAgICBpZiAodGhpcy5yb290RnMucmVhZGRpclN5bmMobW91bnRQb2ludCkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgdGhpcy5yb290RnMucm1kaXJTeW5jKG1vdW50UG9pbnQpO1xyXG4gICAgICAgIG1vdW50UG9pbnQgPSBwYXRoLmRpcm5hbWUobW91bnRQb2ludCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGZpbGUgc3lzdGVtIHRoYXQgdGhlIHBhdGggcG9pbnRzIHRvLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBfZ2V0RnMocGF0aDogc3RyaW5nKToge2ZzOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtOyBwYXRoOiBzdHJpbmd9IHtcclxuICAgIGxldCBtb3VudExpc3QgPSB0aGlzLm1vdW50TGlzdCwgbGVuID0gbW91bnRMaXN0Lmxlbmd0aDtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgbGV0IG1vdW50UG9pbnQgPSBtb3VudExpc3RbaV07XHJcbiAgICAgIC8vIFdlIGtub3cgcGF0aCBpcyBub3JtYWxpemVkLCBzbyBpdCBpcyBhIHN1YnN0cmluZyBvZiB0aGUgbW91bnQgcG9pbnQuXHJcbiAgICAgIGlmIChtb3VudFBvaW50Lmxlbmd0aCA8PSBwYXRoLmxlbmd0aCAmJiBwYXRoLmluZGV4T2YobW91bnRQb2ludCkgPT09IDApIHtcclxuICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIobW91bnRQb2ludC5sZW5ndGggPiAxID8gbW91bnRQb2ludC5sZW5ndGggOiAwKTtcclxuICAgICAgICBpZiAocGF0aCA9PT0gJycpIHtcclxuICAgICAgICAgIHBhdGggPSAnLyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7ZnM6IHRoaXMubW50TWFwW21vdW50UG9pbnRdLCBwYXRoOiBwYXRofTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gUXVlcnkgb3VyIHJvb3QgZmlsZSBzeXN0ZW0uXHJcbiAgICByZXR1cm4ge2ZzOiB0aGlzLnJvb3RGcywgcGF0aDogcGF0aH07XHJcbiAgfVxyXG5cclxuICAvLyBHbG9iYWwgaW5mb3JtYXRpb24gbWV0aG9kc1xyXG5cclxuICBwdWJsaWMgZ2V0TmFtZSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuICdNb3VudGFibGVGaWxlU3lzdGVtJztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkaXNrU3BhY2UocGF0aDogc3RyaW5nLCBjYjogKHRvdGFsOiBudW1iZXIsIGZyZWU6IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgY2IoMCwgMCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNSZWFkT25seSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdXBwb3J0c0xpbmtzKCk6IGJvb2xlYW4ge1xyXG4gICAgLy8gSSdtIG5vdCByZWFkeSBmb3IgY3Jvc3MtRlMgbGlua3MgeWV0LlxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN1cHBvcnRzUHJvcHMoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3VwcG9ydHNTeW5jaCgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRml4ZXMgdXAgZXJyb3IgbWVzc2FnZXMgc28gdGhleSBtZW50aW9uIHRoZSBtb3VudGVkIGZpbGUgbG9jYXRpb24gcmVsYXRpdmVcclxuICAgKiB0byB0aGUgTUZTIHJvb3QsIG5vdCB0byB0aGUgcGFydGljdWxhciBGUydzIHJvb3QuXHJcbiAgICogTXV0YXRlcyB0aGUgaW5wdXQgZXJyb3IsIGFuZCByZXR1cm5zIGl0LlxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhbmRhcmRpemVFcnJvcihlcnI6IEFwaUVycm9yLCBwYXRoOiBzdHJpbmcsIHJlYWxQYXRoOiBzdHJpbmcpOiBBcGlFcnJvciB7XHJcbiAgICB2YXIgaW5kZXg6IG51bWJlcjtcclxuICAgIGlmICgtMSAhPT0gKGluZGV4ID0gZXJyLm1lc3NhZ2UuaW5kZXhPZihwYXRoKSkpIHtcclxuICAgICAgZXJyLm1lc3NhZ2UgPSBlcnIubWVzc2FnZS5zdWJzdHIoMCwgaW5kZXgpICsgcmVhbFBhdGggKyBlcnIubWVzc2FnZS5zdWJzdHIoaW5kZXggKyBwYXRoLmxlbmd0aCk7XHJcbiAgICAgIGVyci5wYXRoID0gcmVhbFBhdGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZXJyO1xyXG4gIH1cclxuXHJcbiAgLy8gVGhlIGZvbGxvd2luZyBtZXRob2RzIGludm9sdmUgbXVsdGlwbGUgZmlsZSBzeXN0ZW1zLCBhbmQgdGh1cyBoYXZlIGN1c3RvbVxyXG4gIC8vIGxvZ2ljLlxyXG4gIC8vIE5vdGUgdGhhdCB3ZSBnbyB0aHJvdWdoIHRoZSBOb2RlIEFQSSB0byB1c2UgaXRzIHJvYnVzdCBkZWZhdWx0IGFyZ3VtZW50XHJcbiAgLy8gcHJvY2Vzc2luZy5cclxuXHJcbiAgcHVibGljIHJlbmFtZShvbGRQYXRoOiBzdHJpbmcsIG5ld1BhdGg6IHN0cmluZywgY2I6IChlPzogQXBpRXJyb3IpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIC8vIFNjZW5hcmlvIDE6IG9sZCBhbmQgbmV3IGFyZSBvbiBzYW1lIEZTLlxyXG4gICAgdmFyIGZzMV9ydiA9IHRoaXMuX2dldEZzKG9sZFBhdGgpO1xyXG4gICAgdmFyIGZzMl9ydiA9IHRoaXMuX2dldEZzKG5ld1BhdGgpO1xyXG4gICAgaWYgKGZzMV9ydi5mcyA9PT0gZnMyX3J2LmZzKSB7XHJcbiAgICAgIHZhciBfdGhpcyA9IHRoaXM7XHJcbiAgICAgIHJldHVybiBmczFfcnYuZnMucmVuYW1lKGZzMV9ydi5wYXRoLCBmczJfcnYucGF0aCwgZnVuY3Rpb24oZT86IEFwaUVycm9yKSB7XHJcbiAgICAgICAgaWYgKGUpIF90aGlzLnN0YW5kYXJkaXplRXJyb3IoX3RoaXMuc3RhbmRhcmRpemVFcnJvcihlLCBmczFfcnYucGF0aCwgb2xkUGF0aCksIGZzMl9ydi5wYXRoLCBuZXdQYXRoKTtcclxuICAgICAgICBjYihlKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gU2NlbmFyaW8gMjogRGlmZmVyZW50IGZpbGUgc3lzdGVtcy5cclxuICAgIC8vIFJlYWQgb2xkIGZpbGUsIHdyaXRlIG5ldyBmaWxlLCBkZWxldGUgb2xkIGZpbGUuXHJcbiAgICByZXR1cm4gZnMucmVhZEZpbGUob2xkUGF0aCwgZnVuY3Rpb24oZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIGNiKGVycik7XHJcbiAgICAgIH1cclxuICAgICAgZnMud3JpdGVGaWxlKG5ld1BhdGgsIGRhdGEsIGZ1bmN0aW9uKGVycikge1xyXG4gICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgIHJldHVybiBjYihlcnIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBmcy51bmxpbmsob2xkUGF0aCwgY2IpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlbmFtZVN5bmMob2xkUGF0aDogc3RyaW5nLCBuZXdQYXRoOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIC8vIFNjZW5hcmlvIDE6IG9sZCBhbmQgbmV3IGFyZSBvbiBzYW1lIEZTLlxyXG4gICAgdmFyIGZzMV9ydiA9IHRoaXMuX2dldEZzKG9sZFBhdGgpO1xyXG4gICAgdmFyIGZzMl9ydiA9IHRoaXMuX2dldEZzKG5ld1BhdGgpO1xyXG4gICAgaWYgKGZzMV9ydi5mcyA9PT0gZnMyX3J2LmZzKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGZzMV9ydi5mcy5yZW5hbWVTeW5jKGZzMV9ydi5wYXRoLCBmczJfcnYucGF0aCk7XHJcbiAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgIHRoaXMuc3RhbmRhcmRpemVFcnJvcih0aGlzLnN0YW5kYXJkaXplRXJyb3IoZSwgZnMxX3J2LnBhdGgsIG9sZFBhdGgpLCBmczJfcnYucGF0aCwgbmV3UGF0aCk7XHJcbiAgICAgICAgdGhyb3cgZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gU2NlbmFyaW8gMjogRGlmZmVyZW50IGZpbGUgc3lzdGVtcy5cclxuICAgIHZhciBkYXRhID0gZnMucmVhZEZpbGVTeW5jKG9sZFBhdGgpO1xyXG4gICAgZnMud3JpdGVGaWxlU3luYyhuZXdQYXRoLCBkYXRhKTtcclxuICAgIHJldHVybiBmcy51bmxpbmtTeW5jKG9sZFBhdGgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlYWRkaXJTeW5jKHA6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGxldCBmc0luZm8gPSB0aGlzLl9nZXRGcyhwKTtcclxuXHJcbiAgICAvLyBJZiBudWxsLCByb290ZnMgZGlkIG5vdCBoYXZlIHRoZSBkaXJlY3RvcnlcclxuICAgIC8vIChvciB0aGUgdGFyZ2V0IEZTIGlzIHRoZSByb290IGZzKS5cclxuICAgIGxldCBydiA9IG51bGw7XHJcbiAgICAvLyBNb3VudCBwb2ludHMgYXJlIGFsbCBkZWZpbmVkIGluIHRoZSByb290IEZTLlxyXG4gICAgLy8gRW5zdXJlIHRoYXQgd2UgbGlzdCB0aG9zZSwgdG9vLlxyXG4gICAgaWYgKGZzSW5mby5mcyAhPT0gdGhpcy5yb290RnMpIHtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICBydiA9IHRoaXMucm9vdEZzLnJlYWRkaXJTeW5jKHApO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgLy8gSWdub3JlLlxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgbGV0IHJ2MiA9IGZzSW5mby5mcy5yZWFkZGlyU3luYyhmc0luZm8ucGF0aCk7XHJcbiAgICAgIGlmIChydiA9PT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybiBydjI7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIG91dCBkdXBsaWNhdGVzLlxyXG4gICAgICAgIHJldHVybiBydjIuY29uY2F0KHJ2LmZpbHRlcigodmFsKSA9PiBydjIuaW5kZXhPZih2YWwpID09PSAtMSkpO1xyXG4gICAgICB9XHJcbiAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgaWYgKHJ2ID09PSBudWxsKSB7XHJcbiAgICAgICAgdGhyb3cgdGhpcy5zdGFuZGFyZGl6ZUVycm9yKGUsIGZzSW5mby5wYXRoLCBwKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBUaGUgcm9vdCBGUyBoYWQgc29tZXRoaW5nLlxyXG4gICAgICAgIHJldHVybiBydjtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHJlYWRkaXIocDogc3RyaW5nLCBjYjogKGVycjogTm9kZUpTLkVycm5vRXhjZXB0aW9uLCBsaXN0aW5nPzogc3RyaW5nW10pID0+IGFueSk6IHZvaWQge1xyXG4gICAgbGV0IGZzSW5mbyA9IHRoaXMuX2dldEZzKHApO1xyXG4gICAgZnNJbmZvLmZzLnJlYWRkaXIoZnNJbmZvLnBhdGgsIChlcnIsIGZpbGVzKSA9PiB7XHJcbiAgICAgIGlmIChmc0luZm8uZnMgIT09IHRoaXMucm9vdEZzKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGxldCBydiA9IHRoaXMucm9vdEZzLnJlYWRkaXJTeW5jKHApO1xyXG4gICAgICAgICAgaWYgKGZpbGVzKSB7XHJcbiAgICAgICAgICAgIC8vIEZpbHRlciBvdXQgZHVwbGljYXRlcy5cclxuICAgICAgICAgICAgZmlsZXMgPSBmaWxlcy5jb25jYXQocnYuZmlsdGVyKCh2YWwpID0+IGZpbGVzLmluZGV4T2YodmFsKSA9PT0gLTEpKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGZpbGVzID0gcnY7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgLy8gUm9vdCBGUyBhbmQgdGFyZ2V0IEZTIGRpZCBub3QgaGF2ZSBkaXJlY3RvcnkuXHJcbiAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYih0aGlzLnN0YW5kYXJkaXplRXJyb3IoZXJyLCBmc0luZm8ucGF0aCwgcCkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChlcnIpIHtcclxuICAgICAgICAvLyBSb290IEZTIGFuZCB0YXJnZXQgRlMgYXJlIHRoZSBzYW1lLCBhbmQgZGlkIG5vdCBoYXZlIGRpcmVjdG9yeS5cclxuICAgICAgICByZXR1cm4gY2IodGhpcy5zdGFuZGFyZGl6ZUVycm9yKGVyciwgZnNJbmZvLnBhdGgsIHApKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgY2IobnVsbCwgZmlsZXMpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcm1kaXJTeW5jKHA6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgbGV0IGZzSW5mbyA9IHRoaXMuX2dldEZzKHApO1xyXG4gICAgaWYgKHRoaXMuX2NvbnRhaW5zTW91bnRQdChwKSkge1xyXG4gICAgICB0aHJvdyBBcGlFcnJvci5FTk9URU1QVFkocCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGZzSW5mby5mcy5ybWRpclN5bmMoZnNJbmZvLnBhdGgpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgdGhyb3cgdGhpcy5zdGFuZGFyZGl6ZUVycm9yKGUsIGZzSW5mby5wYXRoLCBwKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBwYXRoIGNvbnRhaW5zIGEgbW91bnQgcG9pbnQuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBfY29udGFpbnNNb3VudFB0KHA6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgbGV0IG1vdW50UG9pbnRzID0gdGhpcy5tb3VudExpc3QsIGxlbiA9IG1vdW50UG9pbnRzLmxlbmd0aDtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgbGV0IHB0ID0gbW91bnRQb2ludHNbaV07XHJcbiAgICAgIGlmIChwdC5sZW5ndGggPj0gcC5sZW5ndGggJiYgcHQuc2xpY2UoMCwgcC5sZW5ndGgpID09PSBwKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBybWRpcihwOiBzdHJpbmcsIGNiOiAoZXJyPzogTm9kZUpTLkVycm5vRXhjZXB0aW9uKSA9PiBhbnkpOiB2b2lkIHtcclxuICAgIGxldCBmc0luZm8gPSB0aGlzLl9nZXRGcyhwKTtcclxuICAgIGlmICh0aGlzLl9jb250YWluc01vdW50UHQocCkpIHtcclxuICAgICAgY2IoQXBpRXJyb3IuRU5PVEVNUFRZKHApKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGZzSW5mby5mcy5ybWRpcihmc0luZm8ucGF0aCwgKGVycj8pID0+IHtcclxuICAgICAgICBjYihlcnIgPyB0aGlzLnN0YW5kYXJkaXplRXJyb3IoZXJyLCBmc0luZm8ucGF0aCwgcCkgOiBudWxsKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogVHJpY2t5OiBEZWZpbmUgYWxsIG9mIHRoZSBmdW5jdGlvbnMgdGhhdCBtZXJlbHkgZm9yd2FyZCBhcmd1bWVudHMgdG8gdGhlXHJcbiAqIHJlbGV2YW50IGZpbGUgc3lzdGVtLCBvciByZXR1cm4vdGhyb3cgYW4gZXJyb3IuXHJcbiAqIFRha2UgYWR2YW50YWdlIG9mIHRoZSBmYWN0IHRoYXQgdGhlICpmaXJzdCogYXJndW1lbnQgaXMgYWx3YXlzIHRoZSBwYXRoLCBhbmRcclxuICogdGhlICpsYXN0KiBpcyB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gKGlmIGFzeW5jKS5cclxuICogQHRvZG8gQ2FuIHVzZSBudW1BcmdzIHRvIG1ha2UgcHJveHlpbmcgbW9yZSBlZmZpY2llbnQuXHJcbiAqL1xyXG5mdW5jdGlvbiBkZWZpbmVGY24obmFtZTogc3RyaW5nLCBpc1N5bmM6IGJvb2xlYW4sIG51bUFyZ3M6IG51bWJlcik6ICguLi5hcmdzOiBhbnlbXSkgPT4gYW55IHtcclxuICBpZiAoaXNTeW5jKSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24oLi4uYXJnczogYW55W10pIHtcclxuICAgICAgbGV0IHNlbGY6IE1vdW50YWJsZUZpbGVTeXN0ZW0gPSB0aGlzO1xyXG4gICAgICB2YXIgcGF0aCA9IGFyZ3NbMF07XHJcbiAgICAgIHZhciBydiA9IHNlbGYuX2dldEZzKHBhdGgpO1xyXG4gICAgICBhcmdzWzBdID0gcnYucGF0aDtcclxuICAgICAgdHJ5IHtcclxuICAgICAgICByZXR1cm4gcnYuZnNbbmFtZV0uYXBwbHkocnYuZnMsIGFyZ3MpO1xyXG4gICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgKDxhbnk+IHNlbGYpLnN0YW5kYXJkaXplRXJyb3IoZSwgcnYucGF0aCwgcGF0aCk7XHJcbiAgICAgICAgdGhyb3cgZTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICAgIGxldCBzZWxmOiBNb3VudGFibGVGaWxlU3lzdGVtID0gdGhpcztcclxuICAgICAgdmFyIHBhdGggPSBhcmdzWzBdO1xyXG4gICAgICB2YXIgcnYgPSBzZWxmLl9nZXRGcyhwYXRoKTtcclxuICAgICAgYXJnc1swXSA9IHJ2LnBhdGg7XHJcbiAgICAgIGlmICh0eXBlb2YgYXJnc1thcmdzLmxlbmd0aC0xXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgIHZhciBjYiA9IGFyZ3NbYXJncy5sZW5ndGggLSAxXTtcclxuICAgICAgICBhcmdzW2FyZ3MubGVuZ3RoIC0gMV0gPSBmdW5jdGlvbiguLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgICAgICAgaWYgKGFyZ3MubGVuZ3RoID4gMCAmJiBhcmdzWzBdIGluc3RhbmNlb2YgQXBpRXJyb3IpIHtcclxuICAgICAgICAgICAgKDxhbnk+IHNlbGYpLnN0YW5kYXJkaXplRXJyb3IoYXJnc1swXSwgcnYucGF0aCwgcGF0aCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjYi5hcHBseShudWxsLCBhcmdzKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJ2LmZzW25hbWVdLmFwcGx5KHJ2LmZzLCBhcmdzKTtcclxuICAgIH07XHJcbiAgfVxyXG59XHJcblxyXG52YXIgZnNDbWRNYXAgPSBbXHJcbiAgIC8vIDEgYXJnIGZ1bmN0aW9uc1xyXG4gICBbJ2V4aXN0cycsICd1bmxpbmsnLCAncmVhZGxpbmsnXSxcclxuICAgLy8gMiBhcmcgZnVuY3Rpb25zXHJcbiAgIFsnc3RhdCcsICdta2RpcicsICdyZWFscGF0aCcsICd0cnVuY2F0ZSddLFxyXG4gICAvLyAzIGFyZyBmdW5jdGlvbnNcclxuICAgWydvcGVuJywgJ3JlYWRGaWxlJywgJ2NobW9kJywgJ3V0aW1lcyddLFxyXG4gICAvLyA0IGFyZyBmdW5jdGlvbnNcclxuICAgWydjaG93biddLFxyXG4gICAvLyA1IGFyZyBmdW5jdGlvbnNcclxuICAgWyd3cml0ZUZpbGUnLCAnYXBwZW5kRmlsZSddXTtcclxuXHJcbmZvciAodmFyIGkgPSAwOyBpIDwgZnNDbWRNYXAubGVuZ3RoOyBpKyspIHtcclxuICB2YXIgY21kcyA9IGZzQ21kTWFwW2ldO1xyXG4gIGZvciAodmFyIGogPSAwOyBqIDwgY21kcy5sZW5ndGg7IGorKykge1xyXG4gICAgdmFyIGZuTmFtZSA9IGNtZHNbal07XHJcbiAgICAoPGFueT4gTW91bnRhYmxlRmlsZVN5c3RlbS5wcm90b3R5cGUpW2ZuTmFtZV0gPSBkZWZpbmVGY24oZm5OYW1lLCBmYWxzZSwgaSArIDEpO1xyXG4gICAgKDxhbnk+IE1vdW50YWJsZUZpbGVTeXN0ZW0ucHJvdG90eXBlKVtmbk5hbWUgKyAnU3luYyddID0gZGVmaW5lRmNuKGZuTmFtZSArICdTeW5jJywgdHJ1ZSwgaSArIDEpO1xyXG4gIH1cclxufVxyXG4iXX0=