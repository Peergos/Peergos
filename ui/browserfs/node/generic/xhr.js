"use strict";
var util = require('../core/util');
var api_error_1 = require('../core/api_error');
function getIEByteArray(IEByteArray) {
    var rawBytes = IEBinaryToArray_ByteStr(IEByteArray);
    var lastChr = IEBinaryToArray_ByteStr_Last(IEByteArray);
    var data_str = rawBytes.replace(/[\s\S]/g, function (match) {
        var v = match.charCodeAt(0);
        return String.fromCharCode(v & 0xff, v >> 8);
    }) + lastChr;
    var data_array = new Array(data_str.length);
    for (var i = 0; i < data_str.length; i++) {
        data_array[i] = data_str.charCodeAt(i);
    }
    return data_array;
}
function downloadFileIE(async, p, type, cb) {
    switch (type) {
        case 'buffer':
        case 'json':
            break;
        default:
            return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Invalid download type: " + type));
    }
    var req = new XMLHttpRequest();
    req.open('GET', p, async);
    req.setRequestHeader("Accept-Charset", "x-user-defined");
    req.onreadystatechange = function (e) {
        var data_array;
        if (req.readyState === 4) {
            if (req.status === 200) {
                switch (type) {
                    case 'buffer':
                        data_array = getIEByteArray(req.responseBody);
                        return cb(null, new Buffer(data_array));
                    case 'json':
                        return cb(null, JSON.parse(req.responseText));
                }
            }
            else {
                return cb(new api_error_1.ApiError(req.status, "XHR error."));
            }
        }
    };
    req.send();
}
function asyncDownloadFileIE(p, type, cb) {
    downloadFileIE(true, p, type, cb);
}
function syncDownloadFileIE(p, type) {
    var rv;
    downloadFileIE(false, p, type, function (err, data) {
        if (err)
            throw err;
        rv = data;
    });
    return rv;
}
function asyncDownloadFileModern(p, type, cb) {
    var req = new XMLHttpRequest();
    req.open('GET', p, true);
    var jsonSupported = true;
    switch (type) {
        case 'buffer':
            req.responseType = 'arraybuffer';
            break;
        case 'json':
            try {
                req.responseType = 'json';
                jsonSupported = req.responseType === 'json';
            }
            catch (e) {
                jsonSupported = false;
            }
            break;
        default:
            return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Invalid download type: " + type));
    }
    req.onreadystatechange = function (e) {
        if (req.readyState === 4) {
            if (req.status === 200) {
                switch (type) {
                    case 'buffer':
                        return cb(null, new Buffer(req.response ? req.response : 0));
                    case 'json':
                        if (jsonSupported) {
                            return cb(null, req.response);
                        }
                        else {
                            return cb(null, JSON.parse(req.responseText));
                        }
                }
            }
            else {
                return cb(new api_error_1.ApiError(req.status, "XHR error."));
            }
        }
    };
    req.send();
}
function syncDownloadFileModern(p, type) {
    var req = new XMLHttpRequest();
    req.open('GET', p, false);
    var data = null;
    var err = null;
    req.overrideMimeType('text/plain; charset=x-user-defined');
    req.onreadystatechange = function (e) {
        if (req.readyState === 4) {
            if (req.status === 200) {
                switch (type) {
                    case 'buffer':
                        var text = req.responseText;
                        data = new Buffer(text.length);
                        for (var i = 0; i < text.length; i++) {
                            data.writeUInt8(text.charCodeAt(i), i);
                        }
                        return;
                    case 'json':
                        data = JSON.parse(req.responseText);
                        return;
                }
            }
            else {
                err = new api_error_1.ApiError(req.status, "XHR error.");
                return;
            }
        }
    };
    req.send();
    if (err) {
        throw err;
    }
    return data;
}
function syncDownloadFileIE10(p, type) {
    var req = new XMLHttpRequest();
    req.open('GET', p, false);
    switch (type) {
        case 'buffer':
            req.responseType = 'arraybuffer';
            break;
        case 'json':
            break;
        default:
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Invalid download type: " + type);
    }
    var data;
    var err;
    req.onreadystatechange = function (e) {
        if (req.readyState === 4) {
            if (req.status === 200) {
                switch (type) {
                    case 'buffer':
                        data = new Buffer(req.response);
                        break;
                    case 'json':
                        data = JSON.parse(req.response);
                        break;
                }
            }
            else {
                err = new api_error_1.ApiError(req.status, "XHR error.");
            }
        }
    };
    req.send();
    if (err) {
        throw err;
    }
    return data;
}
function getFileSize(async, p, cb) {
    var req = new XMLHttpRequest();
    req.open('HEAD', p, async);
    req.onreadystatechange = function (e) {
        if (req.readyState === 4) {
            if (req.status == 200) {
                try {
                    return cb(null, parseInt(req.getResponseHeader('Content-Length'), 10));
                }
                catch (e) {
                    return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EIO, "XHR HEAD error: Could not read content-length."));
                }
            }
            else {
                return cb(new api_error_1.ApiError(req.status, "XHR HEAD error."));
            }
        }
    };
    req.send();
}
exports.asyncDownloadFile = (util.isIE && typeof Blob === 'undefined') ? asyncDownloadFileIE : asyncDownloadFileModern;
exports.syncDownloadFile = (util.isIE && typeof Blob === 'undefined') ? syncDownloadFileIE : (util.isIE && typeof Blob !== 'undefined') ? syncDownloadFileIE10 : syncDownloadFileModern;
function getFileSizeSync(p) {
    var rv;
    getFileSize(false, p, function (err, size) {
        if (err) {
            throw err;
        }
        rv = size;
    });
    return rv;
}
exports.getFileSizeSync = getFileSizeSync;
function getFileSizeAsync(p, cb) {
    getFileSize(true, p, cb);
}
exports.getFileSizeAsync = getFileSizeAsync;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieGhyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2dlbmVyaWMveGhyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFLQSxJQUFPLElBQUksV0FBVyxjQUFjLENBQUMsQ0FBQztBQUN0QywwQkFBa0MsbUJBQW1CLENBQUMsQ0FBQTtBQU90RCx3QkFBd0IsV0FBZ0I7SUFDdEMsSUFBSSxRQUFRLEdBQUcsdUJBQXVCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsSUFBSSxPQUFPLEdBQUcsNEJBQTRCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDeEQsSUFBSSxRQUFRLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsVUFBUyxLQUFLO1FBQ3ZELElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxHQUFDLElBQUksRUFBRSxDQUFDLElBQUUsQ0FBQyxDQUFDLENBQUE7SUFDMUMsQ0FBQyxDQUFDLEdBQUcsT0FBTyxDQUFDO0lBQ2IsSUFBSSxVQUFVLEdBQUcsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzVDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3pDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFDRCxNQUFNLENBQUMsVUFBVSxDQUFDO0FBQ3BCLENBQUM7QUFFRCx3QkFBd0IsS0FBYyxFQUFFLENBQVMsRUFBRSxJQUFZLEVBQUUsRUFBdUM7SUFDdEcsTUFBTSxDQUFBLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNaLEtBQUssUUFBUSxDQUFDO1FB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QUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbnRhaW5zIHV0aWxpdHkgbWV0aG9kcyBmb3IgcGVyZm9ybWluZyBhIHZhcmlldHkgb2YgdGFza3Mgd2l0aFxyXG4gKiBYbWxIdHRwUmVxdWVzdCBhY3Jvc3MgYnJvd3NlcnMuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHV0aWwgPSByZXF1aXJlKCcuLi9jb3JlL3V0aWwnKTtcclxuaW1wb3J0IHtBcGlFcnJvciwgRXJyb3JDb2RlfSBmcm9tICcuLi9jb3JlL2FwaV9lcnJvcic7XHJcblxyXG4vLyBTZWUgY29yZS9wb2x5ZmlsbHMgZm9yIHRoZSBWQlNjcmlwdCBkZWZpbml0aW9uIG9mIHRoZXNlIGZ1bmN0aW9ucy5cclxuZGVjbGFyZSB2YXIgSUVCaW5hcnlUb0FycmF5X0J5dGVTdHI6ICh2YmFycjogYW55KSA9PiBzdHJpbmc7XHJcbmRlY2xhcmUgdmFyIElFQmluYXJ5VG9BcnJheV9CeXRlU3RyX0xhc3Q6ICh2YmFycjogYW55KSA9PiBzdHJpbmc7XHJcbi8vIENvbnZlcnRzICdyZXNwb25zZUJvZHknIGluIElFIGludG8gdGhlIGVxdWl2YWxlbnQgJ3Jlc3BvbnNlVGV4dCcgdGhhdCBvdGhlclxyXG4vLyBicm93c2VycyB3b3VsZCBnZW5lcmF0ZS5cclxuZnVuY3Rpb24gZ2V0SUVCeXRlQXJyYXkoSUVCeXRlQXJyYXk6IGFueSk6IG51bWJlcltdIHtcclxuICB2YXIgcmF3Qnl0ZXMgPSBJRUJpbmFyeVRvQXJyYXlfQnl0ZVN0cihJRUJ5dGVBcnJheSk7XHJcbiAgdmFyIGxhc3RDaHIgPSBJRUJpbmFyeVRvQXJyYXlfQnl0ZVN0cl9MYXN0KElFQnl0ZUFycmF5KTtcclxuICB2YXIgZGF0YV9zdHIgPSByYXdCeXRlcy5yZXBsYWNlKC9bXFxzXFxTXS9nLCBmdW5jdGlvbihtYXRjaCkge1xyXG4gICAgdmFyIHYgPSBtYXRjaC5jaGFyQ29kZUF0KDApXHJcbiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZSh2JjB4ZmYsIHY+PjgpXHJcbiAgfSkgKyBsYXN0Q2hyO1xyXG4gIHZhciBkYXRhX2FycmF5ID0gbmV3IEFycmF5KGRhdGFfc3RyLmxlbmd0aCk7XHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhX3N0ci5sZW5ndGg7IGkrKykge1xyXG4gICAgZGF0YV9hcnJheVtpXSA9IGRhdGFfc3RyLmNoYXJDb2RlQXQoaSk7XHJcbiAgfVxyXG4gIHJldHVybiBkYXRhX2FycmF5O1xyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZEZpbGVJRShhc3luYzogYm9vbGVhbiwgcDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gIHN3aXRjaCh0eXBlKSB7XHJcbiAgICBjYXNlICdidWZmZXInOlxyXG4gICAgICAvLyBGYWxsdGhyb3VnaFxyXG4gICAgY2FzZSAnanNvbic6XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIGNiKG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIkludmFsaWQgZG93bmxvYWQgdHlwZTogXCIgKyB0eXBlKSk7XHJcbiAgfVxyXG5cclxuICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgcmVxLm9wZW4oJ0dFVCcsIHAsIGFzeW5jKTtcclxuICByZXEuc2V0UmVxdWVzdEhlYWRlcihcIkFjY2VwdC1DaGFyc2V0XCIsIFwieC11c2VyLWRlZmluZWRcIik7XHJcbiAgcmVxLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIHZhciBkYXRhX2FycmF5O1xyXG4gICAgaWYgKHJlcS5yZWFkeVN0YXRlID09PSA0KSB7XHJcbiAgICAgIGlmIChyZXEuc3RhdHVzID09PSAyMDApIHtcclxuICAgICAgICBzd2l0Y2godHlwZSkge1xyXG4gICAgICAgICAgY2FzZSAnYnVmZmVyJzpcclxuICAgICAgICAgICAgZGF0YV9hcnJheSA9IGdldElFQnl0ZUFycmF5KHJlcS5yZXNwb25zZUJvZHkpO1xyXG4gICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbmV3IEJ1ZmZlcihkYXRhX2FycmF5KSk7XHJcbiAgICAgICAgICBjYXNlICdqc29uJzpcclxuICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIEpTT04ucGFyc2UocmVxLnJlc3BvbnNlVGV4dCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKHJlcS5zdGF0dXMsIFwiWEhSIGVycm9yLlwiKSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG4gIHJlcS5zZW5kKCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlSUUocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogTm9kZUJ1ZmZlcikgPT4gdm9pZCk6IHZvaWQ7XHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlSUUocDogc3RyaW5nLCB0eXBlOiAnanNvbicsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQ7XHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlSUUocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQ7XHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlSUUocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gIGRvd25sb2FkRmlsZUlFKHRydWUsIHAsIHR5cGUsIGNiKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZUlFKHA6IHN0cmluZywgdHlwZTogJ2J1ZmZlcicpOiBOb2RlQnVmZmVyO1xyXG5mdW5jdGlvbiBzeW5jRG93bmxvYWRGaWxlSUUocDogc3RyaW5nLCB0eXBlOiAnanNvbicpOiBhbnk7XHJcbmZ1bmN0aW9uIHN5bmNEb3dubG9hZEZpbGVJRShwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueTtcclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZUlFKHA6IHN0cmluZywgdHlwZTogc3RyaW5nKTogYW55IHtcclxuICB2YXIgcnY7XHJcbiAgZG93bmxvYWRGaWxlSUUoZmFsc2UsIHAsIHR5cGUsIGZ1bmN0aW9uKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpIHtcclxuICAgIGlmIChlcnIpIHRocm93IGVycjtcclxuICAgIHJ2ID0gZGF0YTtcclxuICB9KTtcclxuICByZXR1cm4gcnY7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlTW9kZXJuKHA6IHN0cmluZywgdHlwZTogJ2J1ZmZlcicsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IE5vZGVCdWZmZXIpID0+IHZvaWQpOiB2b2lkO1xyXG5mdW5jdGlvbiBhc3luY0Rvd25sb2FkRmlsZU1vZGVybihwOiBzdHJpbmcsIHR5cGU6ICdqc29uJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogYW55KSA9PiB2b2lkKTogdm9pZDtcclxuZnVuY3Rpb24gYXN5bmNEb3dubG9hZEZpbGVNb2Rlcm4ocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQ7XHJcbmZ1bmN0aW9uIGFzeW5jRG93bmxvYWRGaWxlTW9kZXJuKHA6IHN0cmluZywgdHlwZTogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkIHtcclxuICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgcmVxLm9wZW4oJ0dFVCcsIHAsIHRydWUpO1xyXG4gIHZhciBqc29uU3VwcG9ydGVkID0gdHJ1ZTtcclxuICBzd2l0Y2godHlwZSkge1xyXG4gICAgY2FzZSAnYnVmZmVyJzpcclxuICAgICAgcmVxLnJlc3BvbnNlVHlwZSA9ICdhcnJheWJ1ZmZlcic7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgY2FzZSAnanNvbic6XHJcbiAgICAgLy8gU29tZSBicm93c2VycyBkb24ndCBzdXBwb3J0IHRoZSBKU09OIHJlc3BvbnNlIHR5cGUuXHJcbiAgICAgLy8gVGhleSBlaXRoZXIgcmVzZXQgcmVzcG9uc2VUeXBlLCBvciB0aHJvdyBhbiBleGNlcHRpb24uXHJcbiAgICAgLy8gQHNlZSBodHRwczovL2dpdGh1Yi5jb20vTW9kZXJuaXpyL01vZGVybml6ci9ibG9iL21hc3Rlci9zcmMvdGVzdFhoclR5cGUuanNcclxuICAgICAgdHJ5IHtcclxuICAgICAgICByZXEucmVzcG9uc2VUeXBlID0gJ2pzb24nO1xyXG4gICAgICAgIGpzb25TdXBwb3J0ZWQgPSByZXEucmVzcG9uc2VUeXBlID09PSAnanNvbic7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBqc29uU3VwcG9ydGVkID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgICAgYnJlYWs7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIFwiSW52YWxpZCBkb3dubG9hZCB0eXBlOiBcIiArIHR5cGUpKTtcclxuICB9XHJcbiAgcmVxLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIGlmIChyZXEucmVhZHlTdGF0ZSA9PT0gNCkge1xyXG4gICAgICBpZiAocmVxLnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAgICAgc3dpdGNoKHR5cGUpIHtcclxuICAgICAgICAgIGNhc2UgJ2J1ZmZlcic6XHJcbiAgICAgICAgICAgIC8vIFhYWDogV2ViS2l0LWJhc2VkIGJyb3dzZXJzIHJldHVybiAqbnVsbCogd2hlbiBYSFJpbmcgYW4gZW1wdHkgZmlsZS5cclxuICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIG5ldyBCdWZmZXIocmVxLnJlc3BvbnNlID8gcmVxLnJlc3BvbnNlIDogMCkpO1xyXG4gICAgICAgICAgY2FzZSAnanNvbic6XHJcbiAgICAgICAgICAgIGlmIChqc29uU3VwcG9ydGVkKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHJlcS5yZXNwb25zZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGNiKG51bGwsIEpTT04ucGFyc2UocmVxLnJlc3BvbnNlVGV4dCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBjYihuZXcgQXBpRXJyb3IocmVxLnN0YXR1cywgXCJYSFIgZXJyb3IuXCIpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH07XHJcbiAgcmVxLnNlbmQoKTtcclxufVxyXG5cclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZU1vZGVybihwOiBzdHJpbmcsIHR5cGU6ICdidWZmZXInKTogTm9kZUJ1ZmZlcjtcclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZU1vZGVybihwOiBzdHJpbmcsIHR5cGU6ICdqc29uJyk6IGFueTtcclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZU1vZGVybihwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueTtcclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZU1vZGVybihwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueSB7XHJcbiAgdmFyIHJlcSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xyXG4gIHJlcS5vcGVuKCdHRVQnLCBwLCBmYWxzZSk7XHJcblxyXG4gIC8vIE9uIG1vc3QgcGxhdGZvcm1zLCB3ZSBjYW5ub3Qgc2V0IHRoZSByZXNwb25zZVR5cGUgb2Ygc3luY2hyb25vdXMgZG93bmxvYWRzLlxyXG4gIC8vIEB0b2RvIFRlc3QgZm9yIHRoaXM7IElFMTAgYWxsb3dzIHRoaXMsIGFzIGRvIG9sZGVyIHZlcnNpb25zIG9mIENocm9tZS9GRi5cclxuICB2YXIgZGF0YSA9IG51bGw7XHJcbiAgdmFyIGVyciA9IG51bGw7XHJcbiAgLy8gQ2xhc3NpYyBoYWNrIHRvIGRvd25sb2FkIGJpbmFyeSBkYXRhIGFzIGEgc3RyaW5nLlxyXG4gIHJlcS5vdmVycmlkZU1pbWVUeXBlKCd0ZXh0L3BsYWluOyBjaGFyc2V0PXgtdXNlci1kZWZpbmVkJyk7XHJcbiAgcmVxLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIGlmIChyZXEucmVhZHlTdGF0ZSA9PT0gNCkge1xyXG4gICAgICBpZiAocmVxLnN0YXR1cyA9PT0gMjAwKSB7XHJcbiAgICAgICAgc3dpdGNoKHR5cGUpIHtcclxuICAgICAgICAgIGNhc2UgJ2J1ZmZlcic6XHJcbiAgICAgICAgICAgIC8vIENvbnZlcnQgdGhlIHRleHQgaW50byBhIGJ1ZmZlci5cclxuICAgICAgICAgICAgdmFyIHRleHQgPSByZXEucmVzcG9uc2VUZXh0O1xyXG4gICAgICAgICAgICBkYXRhID0gbmV3IEJ1ZmZlcih0ZXh0Lmxlbmd0aCk7XHJcbiAgICAgICAgICAgIC8vIFRocm93IGF3YXkgdGhlIHVwcGVyIGJpdHMgb2YgZWFjaCBjaGFyYWN0ZXIuXHJcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgIC8vIFRoaXMgd2lsbCBhdXRvbWF0aWNhbGx5IHRocm93IGF3YXkgdGhlIHVwcGVyIGJpdCBvZiBlYWNoXHJcbiAgICAgICAgICAgICAgLy8gY2hhcmFjdGVyIGZvciB1cy5cclxuICAgICAgICAgICAgICBkYXRhLndyaXRlVUludDgodGV4dC5jaGFyQ29kZUF0KGkpLCBpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICBjYXNlICdqc29uJzpcclxuICAgICAgICAgICAgZGF0YSA9IEpTT04ucGFyc2UocmVxLnJlc3BvbnNlVGV4dCk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZXJyID0gbmV3IEFwaUVycm9yKHJlcS5zdGF0dXMsIFwiWEhSIGVycm9yLlwiKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG4gIHJlcS5zZW5kKCk7XHJcbiAgaWYgKGVycikge1xyXG4gICAgdGhyb3cgZXJyO1xyXG4gIH1cclxuICByZXR1cm4gZGF0YTtcclxufVxyXG5cclxuLyoqXHJcbiAqIElFMTAgYWxsb3dzIHVzIHRvIHBlcmZvcm0gc3luY2hyb25vdXMgYmluYXJ5IGZpbGUgZG93bmxvYWRzLlxyXG4gKiBAdG9kbyBGZWF0dXJlIGRldGVjdCB0aGlzLCBhcyBvbGRlciB2ZXJzaW9ucyBvZiBGRi9DaHJvbWUgZG8gdG9vIVxyXG4gKi9cclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZUlFMTAocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJyk6IE5vZGVCdWZmZXI7XHJcbmZ1bmN0aW9uIHN5bmNEb3dubG9hZEZpbGVJRTEwKHA6IHN0cmluZywgdHlwZTogJ2pzb24nKTogYW55O1xyXG5mdW5jdGlvbiBzeW5jRG93bmxvYWRGaWxlSUUxMChwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueTtcclxuZnVuY3Rpb24gc3luY0Rvd25sb2FkRmlsZUlFMTAocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpOiBhbnkge1xyXG4gIHZhciByZXEgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcclxuICByZXEub3BlbignR0VUJywgcCwgZmFsc2UpO1xyXG4gIHN3aXRjaCh0eXBlKSB7XHJcbiAgICBjYXNlICdidWZmZXInOlxyXG4gICAgICByZXEucmVzcG9uc2VUeXBlID0gJ2FycmF5YnVmZmVyJztcclxuICAgICAgYnJlYWs7XHJcbiAgICBjYXNlICdqc29uJzpcclxuICAgICAgLy8gSUUxMCBkb2VzIG5vdCBzdXBwb3J0IHRoZSBKU09OIHR5cGUuXHJcbiAgICAgIGJyZWFrO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIFwiSW52YWxpZCBkb3dubG9hZCB0eXBlOiBcIiArIHR5cGUpO1xyXG4gIH1cclxuICB2YXIgZGF0YTtcclxuICB2YXIgZXJyO1xyXG4gIHJlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbihlKSB7XHJcbiAgICBpZiAocmVxLnJlYWR5U3RhdGUgPT09IDQpIHtcclxuICAgICAgaWYgKHJlcS5zdGF0dXMgPT09IDIwMCkge1xyXG4gICAgICAgIHN3aXRjaCh0eXBlKSB7XHJcbiAgICAgICAgICBjYXNlICdidWZmZXInOlxyXG4gICAgICAgICAgICBkYXRhID0gbmV3IEJ1ZmZlcihyZXEucmVzcG9uc2UpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIGNhc2UgJ2pzb24nOlxyXG4gICAgICAgICAgICBkYXRhID0gSlNPTi5wYXJzZShyZXEucmVzcG9uc2UpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZXJyID0gbmV3IEFwaUVycm9yKHJlcS5zdGF0dXMsIFwiWEhSIGVycm9yLlwiKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH07XHJcbiAgcmVxLnNlbmQoKTtcclxuICBpZiAoZXJyKSB7XHJcbiAgICB0aHJvdyBlcnI7XHJcbiAgfVxyXG4gIHJldHVybiBkYXRhO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRGaWxlU2l6ZShhc3luYzogYm9vbGVhbiwgcDogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIHNpemU/OiBudW1iZXIpID0+IHZvaWQpOiB2b2lkIHtcclxuICB2YXIgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcbiAgcmVxLm9wZW4oJ0hFQUQnLCBwLCBhc3luYyk7XHJcbiAgcmVxLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKGUpIHtcclxuICAgIGlmIChyZXEucmVhZHlTdGF0ZSA9PT0gNCkge1xyXG4gICAgICBpZiAocmVxLnN0YXR1cyA9PSAyMDApIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgcmV0dXJuIGNiKG51bGwsIHBhcnNlSW50KHJlcS5nZXRSZXNwb25zZUhlYWRlcignQ29udGVudC1MZW5ndGgnKSwgMTApKTtcclxuICAgICAgICB9IGNhdGNoKGUpIHtcclxuICAgICAgICAgIC8vIEluIHRoZSBldmVudCB0aGF0IHRoZSBoZWFkZXIgaXNuJ3QgcHJlc2VudCBvciB0aGVyZSBpcyBhbiBlcnJvci4uLlxyXG4gICAgICAgICAgcmV0dXJuIGNiKG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlPLCBcIlhIUiBIRUFEIGVycm9yOiBDb3VsZCBub3QgcmVhZCBjb250ZW50LWxlbmd0aC5cIikpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKHJlcS5zdGF0dXMsIFwiWEhSIEhFQUQgZXJyb3IuXCIpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH07XHJcbiAgcmVxLnNlbmQoKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEFzeW5jaHJvbm91c2x5IGRvd25sb2FkIGEgZmlsZSBhcyBhIGJ1ZmZlciBvciBhIEpTT04gb2JqZWN0LlxyXG4gKiBOb3RlIHRoYXQgdGhlIHRoaXJkIGZ1bmN0aW9uIHNpZ25hdHVyZSB3aXRoIGEgbm9uLXNwZWNpYWxpemVkIHR5cGUgaXNcclxuICogaW52YWxpZCwgYnV0IFR5cGVTY3JpcHQgcmVxdWlyZXMgaXQgd2hlbiB5b3Ugc3BlY2lhbGl6ZSBzdHJpbmcgYXJndW1lbnRzIHRvXHJcbiAqIGNvbnN0YW50cy5cclxuICovXHJcbmV4cG9ydCB2YXIgYXN5bmNEb3dubG9hZEZpbGU6IHtcclxuICAocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogTm9kZUJ1ZmZlcikgPT4gdm9pZCk6IHZvaWQ7XHJcbiAgKHA6IHN0cmluZywgdHlwZTogJ2pzb24nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkO1xyXG4gIChwOiBzdHJpbmcsIHR5cGU6IHN0cmluZywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogYW55KSA9PiB2b2lkKTogdm9pZDtcclxufSA9ICh1dGlsLmlzSUUgJiYgdHlwZW9mIEJsb2IgPT09ICd1bmRlZmluZWQnKSA/IGFzeW5jRG93bmxvYWRGaWxlSUUgOiBhc3luY0Rvd25sb2FkRmlsZU1vZGVybjtcclxuXHJcbi8qKlxyXG4gKiBTeW5jaHJvbm91c2x5IGRvd25sb2FkIGEgZmlsZSBhcyBhIGJ1ZmZlciBvciBhIEpTT04gb2JqZWN0LlxyXG4gKiBOb3RlIHRoYXQgdGhlIHRoaXJkIGZ1bmN0aW9uIHNpZ25hdHVyZSB3aXRoIGEgbm9uLXNwZWNpYWxpemVkIHR5cGUgaXNcclxuICogaW52YWxpZCwgYnV0IFR5cGVTY3JpcHQgcmVxdWlyZXMgaXQgd2hlbiB5b3Ugc3BlY2lhbGl6ZSBzdHJpbmcgYXJndW1lbnRzIHRvXHJcbiAqIGNvbnN0YW50cy5cclxuICovXHJcbmV4cG9ydCB2YXIgc3luY0Rvd25sb2FkRmlsZToge1xyXG4gIChwOiBzdHJpbmcsIHR5cGU6ICdidWZmZXInKTogTm9kZUJ1ZmZlcjtcclxuICAocDogc3RyaW5nLCB0eXBlOiAnanNvbicpOiBhbnk7XHJcbiAgKHA6IHN0cmluZywgdHlwZTogc3RyaW5nKTogYW55O1xyXG59ID0gKHV0aWwuaXNJRSAmJiB0eXBlb2YgQmxvYiA9PT0gJ3VuZGVmaW5lZCcpID8gc3luY0Rvd25sb2FkRmlsZUlFIDogKHV0aWwuaXNJRSAmJiB0eXBlb2YgQmxvYiAhPT0gJ3VuZGVmaW5lZCcpID8gc3luY0Rvd25sb2FkRmlsZUlFMTAgOiBzeW5jRG93bmxvYWRGaWxlTW9kZXJuO1xyXG5cclxuLyoqXHJcbiAqIFN5bmNocm9ub3VzbHkgcmV0cmlldmVzIHRoZSBzaXplIG9mIHRoZSBnaXZlbiBmaWxlIGluIGJ5dGVzLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVTaXplU3luYyhwOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gIHZhciBydjogbnVtYmVyO1xyXG4gIGdldEZpbGVTaXplKGZhbHNlLCBwLCBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBzaXplPzogbnVtYmVyKSB7XHJcbiAgICBpZiAoZXJyKSB7XHJcbiAgICAgIHRocm93IGVycjtcclxuICAgIH1cclxuICAgIHJ2ID0gc2l6ZTtcclxuICB9KTtcclxuICByZXR1cm4gcnY7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBBc3luY2hyb25vdXNseSByZXRyaWV2ZXMgdGhlIHNpemUgb2YgdGhlIGdpdmVuIGZpbGUgaW4gYnl0ZXMuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZVNpemVBc3luYyhwOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgc2l6ZT86IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gIGdldEZpbGVTaXplKHRydWUsIHAsIGNiKTtcclxufVxyXG4iXX0=